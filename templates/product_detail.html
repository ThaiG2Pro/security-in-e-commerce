<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ product[1] }} - Product Detail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.4.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body class="bg-gray-100">
  <nav class="bg-white p-4 shadow mb-4">
    <div class="container mx-auto flex justify-between items-center">
      <a href="/" class="text-xl font-bold">E-Commerce</a>
      <div>
        {% if user %}
        <span class="mr-4">Hello, {{ user }}</span>
        <a href="/logout" class="text-blue-500 hover:underline">Logout</a>
        {% else %}
        <a href="/login" class="mr-4 text-blue-500 hover:underline">Login</a>
        <a href="/register" class="text-blue-500 hover:underline">Register</a>
        {% endif %}
        <a href="/cart" class="ml-4 text-blue-500 hover:underline">Cart</a>
      </div>
    </div>
  </nav>
  <div class="container bg-white rounded shadow p-4 mt-4">
    <div class="row">
      <div class="col-md-6">
        <img src="/static/{{ product[7] }}" class="img-fluid rounded mb-3" alt="{{ product[1] }}" />
      </div>
      <div class="col-md-6">
        <h2 class="font-bold text-2xl mb-2">{{ product[1] }}</h2>
        <p class="mb-2">{{ product[2] }}</p>
        <p class="mb-2"><strong>Category:</strong> {{ product[-1] }}</p>
        {% if product[4] and product[4] < product[3] %}
          <span class="text-danger font-weight-bold">${{ product[4]|round(2) }}</span>
          <span class="text-muted"><s>${{ product[3]|round(2) }}</s></span>
          <span class="badge badge-success ml-2">Sale</span>
        {% else %}
          <span class="font-weight-bold">${{ product[3]|round(2) }}</span>
        {% endif %}
        <form id="addToCartForm" class="mt-3">
          {% if variants and variants|length > 0 %}
          <div class="form-group">
            <label for="variant">Choose Variant:</label>
            <select class="form-control" id="variant" name="variant_id">
              {% for v in variants %}
              <option value="{{ v[0] }}">{{ v[2] }}: {{ v[3] }}{% if v[4] and v[4] != 0 %} (+${{ v[4]|round(2) }}){% endif %}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <div class="form-group">
            <label for="quantity">Quantity:</label>
            <input type="number" class="form-control w-24" id="quantity" name="quantity" value="1" min="1" />
          </div>
          <button type="submit" class="btn btn-primary">Add to Cart</button>
          <button type="button" class="btn btn-outline-danger ml-2" onclick="addToWishlist('{{ product[0] }}')">❤ Wishlist</button>
        </form>
      </div>
    </div>
    <hr class="my-4" />
    <div class="row">
      <div class="col-md-8">
        <h4 class="mb-3">Reviews</h4>
        {% if reviews and reviews|length > 0 %}
        <ul class="list-group mb-3">
          {% for r in reviews %}
          <li class="list-group-item">
            <strong>{{ r[2] or 'Anonymous' }}</strong> - <span class="text-warning">{% for i in range(r[3]) %}★{% endfor %}</span>
            <br />
            <span>{{ r[4] }}</span>
            <small class="text-muted float-right">{{ r[5] }}</small>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p>No reviews yet.</p>
        {% endif %}
        <h5>Add a Review</h5>
        <form id="reviewForm">
          <div class="form-group">
            <label for="rating">Rating:</label>
            <select class="form-control w-32" id="rating" name="rating">
              {% for i in range(1,6) %}
              <option value="{{ i }}">{{ i }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="comment">Comment:</label>
            <textarea class="form-control" id="comment" name="comment" rows="2"></textarea>
          </div>
          <button type="submit" class="btn btn-success">Submit Review</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    document.getElementById('addToCartForm').onsubmit = function(e) {
      e.preventDefault();
      const data = new URLSearchParams(new FormData(this));
      fetch('/add_to_cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'product_id={{ product[0] }}&' + data.toString()
      }).then(r => r.json()).then(data => {
        alert(data.message || data.error);
      });
    };
    function addToWishlist(productId) {
      fetch('/add_to_wishlist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'product_id=' + productId
      }).then(r => r.json()).then(data => {
        alert(data.message || data.error);
      });
    }
    document.getElementById('reviewForm').onsubmit = function(e) {
      e.preventDefault();
      const data = new URLSearchParams(new FormData(this));
      fetch('/product/{{ product[0] }}/review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: data.toString()
      }).then(r => r.json()).then(data => {
        alert(data.message || data.error);
        if (data.message) location.reload();
      });
    };
  </script>
</body>
</html>
