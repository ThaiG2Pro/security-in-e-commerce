{% extends 'base.html' %}
{% block title %}Shopping Cart{% endblock %}
{% block content %}
  <div class="container bg-white rounded shadow p-4 mt-4">
    <h2 class="mb-4 font-bold text-2xl">Shopping Cart</h2>
    {% if cart_items and cart_items|length > 0 %}
    <form id="cartForm" action="{{ url_for('user.update_cart') }}" method="POST">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Product</th>
            <th>Variant</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart_items %}
          <tr>
            <td>
              <img src="{{ url_for('static', filename='images/' + item[7]) }}" alt="{{ item[1] }}" style="width:60px; height:60px; object-fit:cover;" class="rounded mr-2" />
              <span class="font-bold">{{ item[1] }}</span>
            </td>
            <td>
              {% if item[-4] %}
              {{ item[-4] }}: {{ item[-3] }}
              {% if item[-2] and item[-2] != 0 %}
              <span class="text-muted">(+${{ item[-2]|round(2) }})</span>
              {% endif %}
              {% else %}
              -
              {% endif %}
            </td>
            <td>
              ${{ (item[3] + (item[-2] or 0))|round(2) }}
            </td>
            <td>
              <input type="number" name="quantity_{{ item[0] }}_{{ item[-3] or 'none' }}" value="{{ item[-1] }}" min="0" class="form-control w-24 quantity-input" data-product-id="{{ item[0] }}" data-variant="{{ item[-3] or 'none' }}" />
            </td>
            <td class="subtotal" data-product-id="{{ item[0] }}" data-variant="{{ item[-3] or 'none' }}">
              ${{ ((item[3] + (item[-2] or 0)) * (item[-1] or 1))|round(2) }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="form-group">
            <label for="coupon">Coupon Code:</label>
            <input type="text" class="form-control w-48 d-inline-block" id="coupon" name="coupon" placeholder="Enter coupon code" />
            <button type="button" class="btn btn-outline-primary ml-2" onclick="applyCoupon()">Apply</button>
          </div>
        </div>
        <div class="col-md-6 text-right">
          <h4>Total: <span id="cart-total" class="text-success">${{ total|round(2) }}</span></h4>
          <button type="button" id="updateCart" class="btn btn-secondary mt-2 me-2">Update Cart</button>
          <a href="{{ url_for('user.delivery') }}" class="btn btn-primary mt-2">Proceed to Checkout</a>
        </div>
      </div>
    </form>
    {% else %}
    <p>Your cart is empty.</p>
    {% endif %}
  </div>
{% endblock %}
{% block scripts %}
<script>
  function applyCoupon() {
    alert("Coupon feature coming soon!");
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const quantityInputs = document.querySelectorAll('.quantity-input');
    const updateCartBtn = document.getElementById('updateCart');
    const cartForm = document.getElementById('cartForm');
    
    // Add event listeners to quantity inputs
    quantityInputs.forEach(input => {
      input.addEventListener('change', function() {
        updateSubtotal(this);
      });
      
      // Also listen for input events to update in real-time as the user types
      input.addEventListener('input', function() {
        updateLocalSubtotal(this);
      });
    });
    
    // Update cart button
    updateCartBtn.addEventListener('click', function() {
      updateCartForm();
    });
    
    // Calculate and update subtotal for a product
    function updateSubtotal(inputElement) {
      const quantity = parseInt(inputElement.value);
      
      if (quantity < 0) {
        inputElement.value = 0;
        return;
      }
      
      // First, update the UI immediately for a responsive feel
      updateLocalSubtotal(inputElement);
      
      // Then send the data to the server (but don't wait for response to update UI)
      const formData = new FormData(cartForm);
      
      // Send AJAX request to update cart
      fetch("{{ url_for('user.update_cart') }}", {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Server has validated the update, can use its values if needed
          updateCartDisplay(data);
        } else {
          alert(data.error || 'An error occurred');
          // Revert to original value if there was an error
          window.location.reload();
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
    
    function updateCartForm() {
      // First, update all subtotals and total locally
      quantityInputs.forEach(input => {
        updateLocalSubtotal(input);
      });
      
      const formData = new FormData(cartForm);
      
      fetch("{{ url_for('user.update_cart') }}", {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateCartDisplay(data);
          alert('Cart updated successfully');
        } else {
          alert(data.error || 'An error occurred');
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
    
    function updateCartDisplay(data) {
      // Update total
      document.getElementById('cart-total').textContent = '$' + data.total.toFixed(2);
      
      // Update each item's subtotal
      data.items.forEach(item => {
        const subtotalElement = document.querySelector(`.subtotal[data-product-id="${item.product_id}"][data-variant="${item.variant_value}"]`);
        if (subtotalElement) {
          subtotalElement.textContent = '$' + item.subtotal.toFixed(2);
        }
      });
      
      // Check if any items were removed (quantity = 0)
      // If so, reload page to remove those rows
      if (data.items.length < quantityInputs.length) {
        window.location.reload();
      }
    }
    
    // Function to update the subtotal locally without waiting for server response
    function updateLocalSubtotal(inputElement) {
      const row = inputElement.closest('tr');
      const priceText = row.querySelector('td:nth-child(3)').textContent.trim();
      const price = parseFloat(priceText.replace('$', ''));
      const quantity = parseInt(inputElement.value) || 0;
      
      // Update the subtotal for this product
      const subtotalCell = row.querySelector('.subtotal');
      const newSubtotal = price * quantity;
      subtotalCell.textContent = '$' + newSubtotal.toFixed(2);
      
      // Update the total
      updateLocalTotal();
    }
    
    // Function to update the total by summing all visible subtotals
    function updateLocalTotal() {
      const subtotalElements = document.querySelectorAll('.subtotal');
      let total = 0;
      
      subtotalElements.forEach(element => {
        const subtotalText = element.textContent.trim();
        const subtotal = parseFloat(subtotalText.replace('$', '')) || 0;
        total += subtotal;
      });
      
      document.getElementById('cart-total').textContent = '$' + total.toFixed(2);
    }
  });
</script>
{% endblock %}
