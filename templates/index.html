<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Commerce</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.4.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <nav class="bg-white p-4 shadow">
      <div class="container mx-auto flex justify-between items-center">
        <a href="/" class="text-xl font-bold">E-Commerce</a>
        <div>
          {% if user %}
          <span class="mr-4">Hello, {{ user }}</span>
          {% if session['role'] == 'admin' %}
          <a href="/admin" class="mr-4 text-red-500 hover:underline">Admin Dashboard</a>
          {% endif %}
          <a href="/logout" class="text-blue-500 hover:underline">Logout</a>
          {% else %}
          <a href="/login" class="mr-4 text-blue-500 hover:underline">Login</a>
          <a href="/register" class="text-blue-500 hover:underline">Register</a>
          {% endif %}
          <a href="/cart" class="ml-4 text-blue-500 hover:underline">Cart</a>
        </div>
      </div>
    </nav>
    <div class="container-fluid">
      <div class="row">
        <!-- Category Sidebar -->
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <h5 class="mt-3">Categories</h5>
            <ul class="nav flex-column">
              {% for category in categories %}
              <li class="nav-item">
                <a class="nav-link" href="/?category_id={{ category[0] }}">{{ category[1] }}</a>
              </li>
              {% endfor %}
            </ul>
          </div>
        </nav>
        <!-- Product Grid -->
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
          <div class="row">
            {% for product in products %}
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                <img
                  src="/static/{{ product[7] }}"
                  class="card-img-top"
                  alt="{{ product[1] }}"
                />
                <div class="card-body">
                  <h5 class="card-title">{{ product[1] }}</h5>
                  <p class="card-text">{{ product[2] }}</p>
                  <p class="card-text">
                    <small class="text-muted">Category: {{ product[-1] }}</small>
                  </p>
                  {% if product[4] and product[4] < product[3] %}
                  <span class="text-danger font-weight-bold">
                    ${{ product[4]|round(2) }}
                  </span>
                  <span class="text-muted">
                    <s>${{ product[3]|round(2) }}</s>
                  </span>
                  <span class="badge badge-success ml-2">Sale</span>
                  {% else %}
                  <span class="font-weight-bold">${{ product[3]|round(2) }}</span>
                  {% endif %}
                  <div class="mt-2">
                    <a
                      href="/product/{{ product[0] }}"
                      class="btn btn-primary btn-sm"
                    >
                      View
                    </a>
                    <button
                      class="btn btn-outline-danger btn-sm"
                      onclick="addToWishlist('{{ product[0] }}')"
                    >
                      ‚ù§ Wishlist
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      data-toggle="modal"
                      data-target="#quickViewModal{{ product[0] }}"
                    >
                      Quick View
                    </button>
                  </div>
                </div>
              </div>
              <!-- Quick View Modal -->
              <div
                class="modal fade"
                id="quickViewModal{{ product[0] }}"
                tabindex="-1"
                role="dialog"
                aria-labelledby="quickViewLabel{{ product[0] }}"
                aria-hidden="true"
              >
                <div class="modal-dialog modal-lg" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5
                        class="modal-title"
                        id="quickViewLabel{{ product[0] }}"
                      >
                        {{ product[1] }}
                      </h5>
                      <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-label="Close"
                      >
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <img
                        src="/static/{{ product[7] }}"
                        class="img-fluid mb-3"
                        alt="{{ product[1] }}"
                      />
                      <p>{{ product[2] }}</p>
                      <p>
                        <strong>Price:</strong> ${{ product[3]|round(2) }}
                      </p>
                      {% if product[4] and product[4] < product[3] %}
                      <p>
                        <strong>Sale Price:</strong>
                        <span class="text-danger">${{ product[4]|round(2) }}</span>
                      </p>
                      {% endif %}
                      <a
                        href="/product/{{ product[0] }}"
                        class="btn btn-primary"
                      >
                        View Details
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </main>
      </div>
    </div>
    <script>
      function addToWishlist(productId) {
        fetch("/add_to_wishlist", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "product_id=" + productId,
        })
          .then((r) => r.json())
          .then((data) => {
            alert(data.message || data.error);
          });
      }
    </script>
    <script src="/static/script.js"></script>
  </body>
</html>
