{% extends 'base.html' %}
{% block title %}Checkout{% endblock %}
{% block content %}
  <div class="container bg-white rounded shadow p-4 mt-4">
    <h2 class="mb-4 font-bold text-2xl">Checkout</h2>
    <form id="checkoutForm">
      <div class="row">
        <div class="col-md-6">
          <h5>Shipping Address</h5>
          <div class="form-group mb-3">
            <select name="address_id" class="form-control mb-2" required>
              <option value="">-- Select a saved address --</option>
              {% for address in addresses %}
                <option value="{{ address[0] }}">
                  {{ address[2] }}{% if address[3] %}, {{ address[3] }}{% endif %},
                  {{ address[4] }}, {{ address[5] }} {{ address[6] }}, {{ address[7] }}
                </option>
              {% endfor %}
              <option value="new">Enter a new address...</option>
            </select>
          </div>
          <div id="newAddressFields" style="display:none;">
            <div class="form-group mb-2">
              <input type="text" class="form-control" name="address_line1" placeholder="Address Line 1" />
            </div>
            <div class="form-group mb-2">
              <input type="text" class="form-control" name="address_line2" placeholder="Address Line 2 (optional)" />
            </div>
            <div class="row mb-2">
              <div class="col">
                <input type="text" class="form-control" name="city" placeholder="City" />
              </div>
              <div class="col">
                <input type="text" class="form-control" name="state" placeholder="State/Province" />
              </div>
            </div>
            <div class="row mb-2">
              <div class="col">
                <input type="text" class="form-control" name="postal_code" placeholder="Postal Code" />
              </div>
              <div class="col">
                <input type="text" class="form-control" name="country" placeholder="Country" />
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <h5>Payment Method</h5>
          <div class="form-group mb-3">
            <select name="payment_method_id" class="form-control mb-2" required>
              <option value="">-- Select a payment method --</option>
              {% for pm in payment_methods %}
                <option value="{{ pm[0] }}">{{ pm[2] }} {{ pm[3] }} (ending in {{ pm[4][-4:] }})</option>
              {% endfor %}
              <option value="balance">Use account balance: ${{ balance|round(2) }}</option>
            </select>
          </div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col-md-6">
          <h5>Shipping Method</h5>
          <select class="form-control" name="shipping_method">
            <option>Standard Shipping (3-5 days)</option>
            <option>Express Shipping (1-2 days)</option>
          </select>
        </div>
        <div class="col-md-6">
          <h5>Order Summary</h5>
          <ul class="list-group mb-2">
            {% for item in cart_items %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ item[1] }} x {{ item[-1] or 1 }}
              <span>${{ ((item[3] + (item[-2] or 0)) * (item[-1] or 1))|round(2) }}</span>
            </li>
            {% endfor %}
          </ul>
          <div class="text-right font-bold">Total: ${{ total|round(2) }}</div>
        </div>
      </div>
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" id="terms" required />
        <label class="form-check-label" for="terms">
          I agree to the terms and conditions
        </label>
      </div>
      <div class="text-right mt-4">
        <button type="submit" class="btn btn-success">Place Order</button>
      </div>
    </form>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Handle the address selection change
      const addressSelect = document.querySelector('select[name="address_id"]');
      const newAddressFields = document.getElementById('newAddressFields');
      
      if (addressSelect) {
        addressSelect.addEventListener('change', function() {
          if (this.value === 'new') {
            newAddressFields.style.display = 'block';
          } else {
            newAddressFields.style.display = 'none';
          }
        });
      }
      
      // Form submission handler
      document.getElementById('checkoutForm').onsubmit = function(e) {
        e.preventDefault();
      
      // Collect form data
      const formData = new FormData(this);
      const serializedData = new URLSearchParams(formData).toString();
      
      // Validate form
      if (!this.checkValidity()) {
        this.reportValidity();
        return false;
      }
      
      // Submit order
      fetch('{{ url_for("user.checkout") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: serializedData
      }).then(r => r.json()).then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          alert(data.message || 'Order placed successfully!');
          if (data.order_id) window.location = '{{ url_for("user.orders") }}';
        }
      }).catch(err => {
        console.error(err);
        alert('An error occurred while processing your order. Please try again.');
      });
    };
  </script>
{% endblock %}
